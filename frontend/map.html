<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ù‚Ø´Ù‡ Ø²Ù†Ø¯Ù‡ Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù† - Ù‡Ø±Ù…Ø²Ú¯Ø§Ù† Ø¯Ø±Ø§ÛŒÙˆØ± Ù¾Ø±Ùˆ</title>
    
    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù†Ù‚Ø´Ù‡ Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Font Awesome Ø¨Ø±Ø§ÛŒ Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ÙÙˆÙ†Øª ÙØ§Ø±Ø³ÛŒ -->
    <link href="https://cdn.jsdelivr.net/npm/vazirmatn@33.0.0/Vazirmatn-font-face.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', 'Segoe UI', Tahoma, sans-serif;
        }
        
        body {
            background: #1a1a2e;
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* Ù†ÙˆØ§Ø± Ú©Ù†Ø§Ø±ÛŒ */
        .sidebar {
            width: 380px;
            background: rgba(30, 30, 46, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            overflow-y: auto;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Ù†Ù‚Ø´Ù‡ */
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Ù‡Ø¯Ø± */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo {
            font-size: 2rem;
            color: #00ff88;
            margin-bottom: 10px;
        }
        
        .title {
            font-size: 1.6rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #00ff88;
        }
        
        .subtitle {
            color: #aaa;
            font-size: 0.9rem;
        }
        
        /* Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ */
        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s;
        }
        
        .card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            color: #00d4ff;
            font-size: 1.2rem;
        }
        
        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .btn-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .btn {
            background: linear-gradient(135deg, #00A693, #008374);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Vazirmatn';
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 166, 147, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #003366, #004080);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #FF6B6B, #ff4444);
        }
        
        /* Ù„ÛŒØ³Øª Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù† */
        .driver-list {
            margin-top: 20px;
        }
        
        .driver-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .driver-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(-5px);
        }
        
        .driver-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #00A693, #003366);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .driver-info {
            flex: 1;
        }
        
        .driver-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .driver-status {
            font-size: 0.85rem;
            color: #aaa;
        }
        
        .driver-status.available {
            color: #00ff88;
        }
        
        .driver-status.on-trip {
            color: #ffcc00;
        }
        
        /* Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ù†Ù‚Ø´Ù‡ */
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }
        
        .control-btn {
            background: white;
            color: #003366;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        /* Ù¾Ù†Ù„ Ø¬Ø³ØªØ¬Ùˆ */
        .search-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 350px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
        }
        
        .search-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #00A693;
            border-radius: 8px;
            font-family: 'Vazirmatn';
            font-size: 1rem;
            margin-bottom: 15px;
            color: #333;
        }
        
        .search-results {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .search-result-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s;
            color: #333;
        }
        
        .search-result-item:hover {
            background: #f5f5f5;
        }
        
        /* Ø±Ø§Ù‡Ù†Ù…Ø§ */
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            color: #333;
            z-index: 1000;
            max-width: 250px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }
        
        .legend-color.driver {
            background: #00A693;
        }
        
        .legend-color.passenger {
            background: #FF6B6B;
        }
        
        .legend-color.hotspot {
            background: #FFCC00;
        }
        
        /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù†â€ŒÙ‡Ø§ */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh;
            }
            
            .map-container {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ù†Ù‚Ø´Ù‡ -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ù†Ù‚Ø´Ù‡ -->
            <div class="map-controls">
                <button class="control-btn" onclick="locateMe()" title="Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†">
                    <i class="fas fa-location-crosshairs"></i>
                </button>
                <button class="control-btn" onclick="refreshDrivers()" title="Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù†">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="control-btn" onclick="showTraffic()" title="ØªØ±Ø§ÙÛŒÚ© Ø²Ù†Ø¯Ù‡">
                    <i class="fas fa-traffic-light"></i>
                </button>
                <button class="control-btn" onclick="showSearch()" title="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ú©Ø§Ù†">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <!-- Ù¾Ù†Ù„ Ø¬Ø³ØªØ¬Ùˆ -->
            <div class="search-panel" id="searchPanel">
                <input type="text" class="search-input" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ú©Ø§Ù† (Ù…Ø«Ø§Ù„: Ù…ÛŒØ¯Ø§Ù† Ø´Ù‡Ø¯Ø§ Ø¨Ù†Ø¯Ø±Ø¹Ø¨Ø§Ø³)" 
                       id="searchInput" onkeypress="if(event.key === 'Enter') searchLocation()">
                <div class="search-results" id="searchResults"></div>
            </div>
            
            <!-- Ø±Ø§Ù‡Ù†Ù…Ø§ -->
            <div class="legend">
                <h4 style="margin-bottom: 15px; color: #003366;">ğŸ—ºï¸ Ù†Ù…Ø§Ø¯Ù‡Ø§</h4>
                <div class="legend-item">
                    <div class="legend-color driver"></div>
                    <span>Ø±Ø§Ù†Ù†Ø¯Ù‡ ÙØ¹Ø§Ù„</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color passenger"></div>
                    <span>Ù…Ø³Ø§ÙØ±</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color hotspot"></div>
                    <span>Ù†Ù‚Ø·Ù‡ Ù¾Ø±ØªØ±Ø§ÙÛŒÚ©</span>
                </div>
            </div>
        </div>
        
        <!-- Ù†ÙˆØ§Ø± Ú©Ù†Ø§Ø±ÛŒ -->
        <div class="sidebar">
            <div class="header">
                <div class="logo">ğŸš•</div>
                <div class="title">Ù†Ù‚Ø´Ù‡ Ø²Ù†Ø¯Ù‡ Ù‡Ø±Ù…Ø²Ú¯Ø§Ù† Ø¯Ø±Ø§ÛŒÙˆØ± Ù¾Ø±Ùˆ</div>
                <div class="subtitle">Ù…ÙˆÙ‚Ø¹ÛŒØª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù† Ùˆ ØªØ±Ø§ÙÛŒÚ© Ø¨Ù†Ø¯Ø±Ø¹Ø¨Ø§Ø³</div>
                
                <div style="margin-top: 15px; font-size: 0.8rem; color: #00ff88;">
                    <i class="fas fa-key"></i> Ú©Ù„ÛŒØ¯ Ù†Ù‚Ø´Ù‡: service.a26822ae...
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-map-marked-alt"></i>
                    <span>ÙˆØ¶Ø¹ÛŒØª Ù†Ù‚Ø´Ù‡</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <div>
                        <div style="font-size: 0.9rem; color: #aaa;">Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†</div>
                        <div id="onlineCount" style="font-size: 2rem; font-weight: bold;">0</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: #aaa;">Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†</div>
                        <div id="myLocation" style="font-size: 0.9rem;">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</div>
                    </div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn" onclick="getRoute()">
                    <i class="fas fa-route"></i>
                    Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ
                </button>
                <button class="btn btn-secondary" onclick="showHotspots()">
                    <i class="fas fa-fire"></i>
                    Ù†Ù‚Ø§Ø· Ø¯Ø§Øº
                </button>
                <button class="btn" onclick="simulateRide()">
                    <i class="fas fa-play-circle"></i>
                    Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ
                </button>
                <button class="btn btn-secondary" onclick="exportMap()">
                    <i class="fas fa-download"></i>
                    Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‚Ø´Ù‡
                </button>
            </div>
            
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-info-circle"></i>
                    <span>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…</span>
                </div>
                <div id="systemInfo">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Backend:</span>
                        <span id="backendStatus" style="color: #00ff88;">âœ… Ù…ØªØµÙ„</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>API Ù†Ù‚Ø´Ù‡:</span>
                        <span id="mapApiStatus" style="color: #00ff88;">âœ… ÙØ¹Ø§Ù„</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ:</span>
                        <span id="lastUpdate">Ù‡Ù… Ø§Ú©Ù†ÙˆÙ†</span>
                    </div>
                </div>
            </div>
            
            <div class="driver-list">
                <div class="card-title">
                    <i class="fas fa-users"></i>
                    <span>Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù† Ù†Ø²Ø¯ÛŒÚ©</span>
                </div>
                <div id="driversList">
                    <!-- Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù† Ø§ÛŒÙ†Ø¬Ø§ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                    <div style="text-align: center; padding: 20px; color: #aaa;">
                        <i class="fas fa-spinner fa-spin"></i> Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù†...
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px; background: rgba(0, 166, 147, 0.1);">
                <div class="card-title">
                    <i class="fas fa-cog"></i>
                    <span>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù†Ù‚Ø´Ù‡</span>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="changeMapStyle('standard')" style="flex:1; padding: 10px; background: #003366; color: white; border: none; border-radius: 5px;">
                        Ù†Ù‚Ø´Ù‡ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯
                    </button>
                    <button onclick="changeMapStyle('satellite')" style="flex:1; padding: 10px; background: #004080; color: white; border: none; border-radius: 5px;">
                        Ù…Ø§Ù‡ÙˆØ§Ø±Ù‡â€ŒØ§ÛŒ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¬Ù‡Ø§Ù†ÛŒ
        let map;
        let driverMarkers = [];
        let myLocationMarker;
        let routeLayer;
        let trafficLayer;
        let myLocation = { lat: 27.1832, lng: 56.2666 };
        const API_BASE = 'http://localhost:3000';
        const NESHAN_API_KEY = 'service.a26822ae11b84924a29a13225498abf0';
        
        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù†Ù‚Ø´Ù‡
        function initMap() {
            // Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù‚Ø´Ù‡
            map = L.map('map').setView([myLocation.lat, myLocation.lng], 14);
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù†Ù‚Ø´Ù‡ Ù¾Ø§ÛŒÙ‡ (Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² OpenStreetMap Ø¨Ù‡ Ø¬Ø§ÛŒ Neshan Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒ)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap',
                maxZoom: 19,
            }).addTo(map);
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ù†Ù‚Ø´Ù‡
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†
            myLocationMarker = L.marker([myLocation.lat, myLocation.lng], {
                icon: L.divIcon({
                    className: 'my-location-marker',
                    html: '<div style="background: #00A693; width: 35px; height: 35px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 15px rgba(0, 166, 147, 0.8);"></div>',
                    iconSize: [35, 35]
                })
            }).addTo(map);
            
            myLocationMarker.bindPopup('<b>Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†</b><br>Ø¨Ù†Ø¯Ø±Ø¹Ø¨Ø§Ø³ØŒ Ù…Ø±Ú©Ø² Ø´Ù‡Ø±').openPopup();
            
            // Ø¯Ø±ÛŒØ§ÙØª Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù†
            loadDrivers();
            
            // Ø´Ø±ÙˆØ¹ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±
            setInterval(loadDrivers, 30000); // Ù‡Ø± 30 Ø«Ø§Ù†ÛŒÙ‡
        }
        
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù† Ø§Ø² API
        async function loadDrivers() {
            try {
                const response = await fetch(`${API_BASE}/api/map/drivers?lat=${myLocation.lat}&lng=${myLocation.lng}`);
                const data = await response.json();
                
                if (data.success) {
                    updateDriversOnMap(data.drivers);
                    updateDriverList(data.drivers);
                    updateOnlineCount(data.drivers.length);
                    updateLastUpdate();
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù†:', error);
                // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡
                const sampleDrivers = [
                    {
                        id: 'DRV-001',
                        name: 'Ø±Ø¶Ø§ Ù…Ø­Ù…Ø¯ÛŒ',
                        status: 'available',
                        location: { lat: 27.1865 + (Math.random() * 0.01 - 0.005), lng: 56.2768 + (Math.random() * 0.01 - 0.005) },
                        rating: 4.8,
                        phone: '09121234567'
                    },
                    {
                        id: 'DRV-002',
                        name: 'Ø¹Ù„ÛŒ Ú©Ø±ÛŒÙ…ÛŒ',
                        status: 'available',
                        location: { lat: 27.1920 + (Math.random() * 0.01 - 0.005), lng: 56.2650 + (Math.random() * 0.01 - 0.005) },
                        rating: 4.9,
                        phone: '09129876543'
                    },
                    {
                        id: 'DRV-003',
                        name: 'Ù…Ø­Ù…Ø¯ Ø­Ø³ÛŒÙ†ÛŒ',
                        status: 'on_trip',
                        location: { lat: 27.1750 + (Math.random() * 0.01 - 0.005), lng: 56.2850 + (Math.random() * 0.01 - 0.005) },
                        rating: 4.7,
                        phone: '09131112233'
                    }
                ];
                updateDriversOnMap(sampleDrivers);
                updateDriverList(sampleDrivers);
                updateOnlineCount(sampleDrivers.length);
            }
        }
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù† Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡
        function updateDriversOnMap(drivers) {
            // Ø­Ø°Ù Ù…Ø§Ø±Ú©Ø±Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
            driverMarkers.forEach(marker => map.removeLayer(marker));
            driverMarkers = [];
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø§Ø±Ú©Ø±Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
            drivers.forEach(driver => {
                const iconColor = driver.status === 'available' ? '#00A693' : '#FFCC00';
                const icon = L.divIcon({
                    className: 'driver-marker',
                    html: `
                        <div style="
                            background: ${iconColor};
                            width: 40px;
                            height: 40px;
                            border-radius: 50%;
                            border: 3px solid white;
                            box-shadow: 0 0 10px rgba(0,0,0,0.3);
                            display: flex;
    
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 1.2rem;
                        ">
                            <i class="fas fa-car"></i>
                        </div>
                    `,
                    iconSize: [40, 40]
                });
                
                const marker = L.marker([driver.location.lat, driver.location.lng], { icon }).addTo(map);
                
                marker.bindPopup(`
                    <b>${driver.name}</b><br>
                    ÙˆØ¶Ø¹ÛŒØª: ${driver.status === 'available' ? 'Ø¢Ù…Ø§Ø¯Ù‡' : 'Ø¯Ø± Ø³ÙØ±'}<br>
                    Ø§Ù…ØªÛŒØ§Ø²: ${driver.rating}/5<br>
                    ØªÙ„ÙÙ†: ${driver.phone}<br>
                    <button onclick="selectDriver('${driver.id}')" 
                            style="background: #00A693; color: white; border: none; padding: 5px 10px; 
                                   border-radius: 5px; margin-top: 5px; cursor: pointer;">
                        Ø§Ù†ØªØ®Ø§Ø¨ Ø±Ø§Ù†Ù†Ø¯Ù‡
                    </button>
                `);
                
                driverMarkers.push(marker);
            });
        }
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù† Ø¯Ø± Ø³Ø§ÛŒØ¯Ø¨Ø§Ø±
        function updateDriverList(drivers) {
            const driversList = document.getElementById('driversList');
            driversList.innerHTML = '';
            
            drivers.forEach(driver => {
                const statusText = driver.status === 'available' ? 'Ø¢Ù…Ø§Ø¯Ù‡' : 'Ø¯Ø± Ø³ÙØ±';
                const statusClass = driver.status === 'available' ? 'available' : 'on-trip';
                const distance = getDistanceFromMe(driver.location).toFixed(1);
                
                const driverItem = document.createElement('div');
                driverItem.className = 'driver-item';
                driverItem.onclick = () => flyToDriver(driver.location);
                driverItem.innerHTML = `
                    <div class="driver-avatar">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="driver-info">
                        <div class="driver-name">${driver.name}</div>
                        <div class="driver-status ${statusClass}">
                            <i class="fas fa-circle" style="font-size: 0.6rem;"></i>
                            ${statusText} | â­ ${driver.rating}
                        </div>
                    </div>
                    <div style="color: #00d4ff;">
                        ${distance} Ú©ÛŒÙ„ÙˆÙ…ØªØ±
                    </div>
                `;
                
                driversList.appendChild(driverItem);
            });
        }
        
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡ Ø§Ø² Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†
        function getDistanceFromMe(location) {
            const R = 6371; // Ø´Ø¹Ø§Ø¹ Ø²Ù…ÛŒÙ† Ø¨Ù‡ Ú©ÛŒÙ„ÙˆÙ…ØªØ±
            const dLat = (location.lat - myLocation.lat) * Math.PI / 180;
            const dLng = (location.lng - myLocation.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(myLocation.lat * Math.PI / 180) * Math.cos(location.lat * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Ù¾Ø±ÙˆØ§Ø² Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±Ø§Ù†Ù†Ø¯Ù‡
        function flyToDriver(location) {
            map.flyTo([location.lat, location.lng], 16, {
                duration: 1.5
            });
        }
        
        // Ø§Ù†ØªØ®Ø§Ø¨ Ø±Ø§Ù†Ù†Ø¯Ù‡
        function selectDriver(driverId) {
            alert(`Ø±Ø§Ù†Ù†Ø¯Ù‡ ${driverId} Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯\nØ§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø§Ù…Ø§Ù†Ù‡ Ø±Ø²Ø±Ùˆ...`);
            // Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ù‡ ØµÙØ­Ù‡ Ø±Ø²Ø±Ùˆ Ù‡Ø¯Ø§ÛŒØª Ú©Ù†ÛŒØ¯
            // window.location.href = `booking.html?driver=${driverId}`;
        }
        
        // Ø¯Ø±ÛŒØ§ÙØª Ù…Ø³ÛŒØ±
        async function getRoute() {
            const destination = prompt('Ù„Ø·ÙØ§ Ù…Ù‚ØµØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹: Ù…ÛŒØ¯Ø§Ù† Ø´Ù‡Ø¯Ø§ Ø¨Ù†Ø¯Ø±Ø¹Ø¨Ø§Ø³):', 'Ù…ÛŒØ¯Ø§Ù† Ø´Ù‡Ø¯Ø§ Ø¨Ù†Ø¯Ø±Ø¹Ø¨Ø§Ø³');
            if (!destination) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/map/route?origin=${myLocation.lat},${myLocation.lng}&destination=${encodeURIComponent(destination)}`);
                const data = await response.json();
                
                if (data.success && data.route) {
                    showRouteOnMap(data.route);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…Ø³ÛŒØ±:', error);
                alert('Ø§Ø² Ù…Ø³ÛŒØ± Ù†Ù…ÙˆÙ†Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯');
                // Ù…Ø³ÛŒØ± Ù†Ù…ÙˆÙ†Ù‡
                const sampleRoute = {
                    distance: { text: '8.5 Ú©ÛŒÙ„ÙˆÙ…ØªØ±' },
                    duration: { text: '12 Ø¯Ù‚ÛŒÙ‚Ù‡' },
                    legs: [{
                        steps: [
                            { instruction: 'Ø¨Ù‡ Ø³Ù…Øª Ø´Ù…Ø§Ù„ Ø¨Ø±ÙˆÛŒØ¯' },
                            { instruction: 'Ø¨Ù‡ Ù…ÛŒØ¯Ø§Ù† Ø´Ù‡Ø¯Ø§ Ø¨Ù¾ÛŒÚ†ÛŒØ¯' },
                            { instruction: 'Ø¨Ù‡ Ù…Ù‚ØµØ¯ Ø¨Ø±Ø³ÛŒØ¯' }
                        ]
                    }]
                };
                showRouteOnMap(sampleRoute);
            }
        }
        
        // Ù†Ù…Ø§ÛŒØ´ Ù…Ø³ÛŒØ± Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡
        function showRouteOnMap(route) {
            // Ø­Ø°Ù Ù…Ø³ÛŒØ± Ù‚Ø¨Ù„ÛŒ
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }
            
            // Ù…Ø®ØªØµØ§Øª Ù†Ù…ÙˆÙ†Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´
            const routeCoordinates = [
                [myLocation.lat, myLocation.lng],
                [27.1865, 56.2768],
                [27.1920, 56.2650]
            ];
            
            // Ø±Ø³Ù… Ù…Ø³ÛŒØ±
            routeLayer = L.polyline(routeCoordinates, {
                color: '#00A693',
                weight: 4,
                opacity: 0.8,
                dashArray: '10, 10'
            }).addTo(map);
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù†Ù‚Ø§Ø· Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù†
            L.marker(routeCoordinates[0], {
                icon: L.divIcon({
                    className: 'start-marker',
                    html: '<div style="background: #00ff88; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white;"></div>',
                    iconSize: [30, 30]
                })
            }).addTo(map).bindPopup('<b>Ø´Ø±ÙˆØ¹</b>');
            
            L.marker(routeCoordinates[routeCoordinates.length - 1], {
                icon: L.divIcon({
                    className: 'end-marker',
                    html: '<div style="background: #FF6B6B; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white;"></div>',
                    iconSize: [30, 30]
                })
            }).addTo(map).bindPopup('<b>Ù…Ù‚ØµØ¯</b>');
            
            // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø³ÛŒØ±
            alert(`Ù…Ø³ÛŒØ± ÛŒØ§ÙØª Ø´Ø¯!\n\nğŸ“ ÙØ§ØµÙ„Ù‡: ${route.distance?.text || '8.5 Ú©ÛŒÙ„ÙˆÙ…ØªØ±'}\nâ±ï¸ Ø²Ù…Ø§Ù†: ${route.duration?.text || '12 Ø¯Ù‚ÛŒÙ‚Ù‡'}`);
        }
        
        // Ù†Ù…Ø§ÛŒØ´ ØªØ±Ø§ÙÛŒÚ©
        async function showTraffic() {
            try {
                const response = await fetch(`${API_BASE}/api/map/traffic?lat=${myLocation.lat}&lng=${myLocation.lng}`);
                const data = await response.json();
                
                if (data.success) {
                    displayTrafficInfo(data.traffic);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ±Ø§ÙÛŒÚ©:', error);
                displayTrafficInfo({
                    level: 'moderate',
                    speed: 45,
                    congestion: 65
                });
            }
        }
        
        // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªØ±Ø§ÙÛŒÚ©
        function displayTrafficInfo(traffic) {
            const levelText = {
                'light': 'Ø³Ø¨Ú© ğŸŸ¢',
                'moderate': 'Ù…ØªÙˆØ³Ø· ğŸŸ¡',
                'heavy': 'Ø³Ù†Ú¯ÛŒÙ† ğŸŸ ',
                'severe': 'Ø´Ø¯ÛŒØ¯ ğŸ”´'
            };
            
            alert(`ğŸš¦ ÙˆØ¶Ø¹ÛŒØª ØªØ±Ø§ÙÛŒÚ© Ù…Ø±Ú©Ø² Ø¨Ù†Ø¯Ø±Ø¹Ø¨Ø§Ø³:\n\nØ³Ø·Ø­: ${levelText[traffic.level] || 'Ù…ØªÙˆØ³Ø· ğŸŸ¡'}\nØ³Ø±Ø¹Øª: ${traffic.speed || 45} Ú©ÛŒÙ„ÙˆÙ…ØªØ±/Ø³Ø§Ø¹Øª\nØªØ±Ø§Ú©Ù…: ${traffic.congestion || 65}%`);
        }
        
        // Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ú©Ø§Ù†
        function showSearch() {
            const panel = document.getElementById('searchPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        async function searchLocation() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/map/search?query=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                const resultsDiv = document.getElementById('searchResults');
                resultsDiv.innerHTML = '';
                
                if (data.success && data.results.length > 0) {
                    data.results.forEach(result => {
                        const item = document.createElement('div');
                        item.className = 'search-result-item';
                        item.innerHTML = `
                            <div><strong>${result.title}</strong></div>
                            <div style="font-size: 0.9rem; color: #666;">${result.address}</div>
                        `;
                        item.onclick = () => {
                            map.flyTo([result.location.lat, result.location.lng], 16);
                            document.getElementById('searchPanel').style.display = 'none';
                        };
                        resultsDiv.appendChild(item);
                    });
                } else {
                    resultsDiv.innerHTML = '<div style="padding: 10px; text-align: center; color: #666;">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ:', error);
            }
        }
        
        // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†
        function locateMe() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    myLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡
                    map.setView([myLocation.lat, myLocation.lng], 16);
                    myLocationMarker.setLatLng([myLocation.lat, myLocation.lng]);
                    
                    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´
                    document.getElementById('myLocation').textContent = 
                        `${myLocation.lat.toFixed(4)}, ${myLocation.lng.toFixed(4)}`;
                    
                    // Ø¯Ø±ÛŒØ§ÙØª Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù† Ù†Ø²Ø¯ÛŒÚ©
                    loadDrivers();
                }, error => {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª:', error);
                    alert('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù…Ú©Ù† Ù†ÛŒØ³Øª. Ø§Ø² Ù…ÙˆÙ‚Ø¹ÛŒØª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.');
                });
            } else {
                alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.');
            }
        }
        
        // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø³ÙØ±
        function simulateRide() {
            if (driverMarkers.length === 0) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù† Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯.');
                return;
            }
            
            const driverMarker = driverMarkers[0];
            const driverLatLng = driverMarker.getLatLng();
            
            // Ø­Ø±Ú©Øª Ø±Ø§Ù†Ù†Ø¯Ù‡ Ø¨Ù‡ Ø³Ù…Øª Ù…Ù†
            const steps = 50;
            const latStep = (myLocation.lat - driverLatLng.lat) / steps;
            const lngStep = (myLocation.lng - driverLatLng.lng) / steps;
            
            let step = 0;
            const moveInterval = setInterval(() => {
                if (step >= steps) {
                    clearInterval(moveInterval);
                    alert('Ø±Ø§Ù†Ù†Ø¯Ù‡ Ø¨Ù‡ Ù…Ù‚ØµØ¯ Ø±Ø³ÛŒØ¯!');
                    return;
                }
                
                const newLat = driverLatLng.lat + (latStep * step);
                const newLng = driverLatLng.lng + (lngStep * step);
                driverMarker.setLatLng([newLat, newLng]);
                step++;
            }, 100);
        }
        
        // Ù†Ù…Ø§ÛŒØ´ Ù†Ù‚Ø§Ø· Ø¯Ø§Øº ØªØ±Ø§ÙÛŒÚ©
        function showHotspots() {
            // Ù†Ù‚Ø§Ø· Ø¯Ø§Øº Ù†Ù…ÙˆÙ†Ù‡
            const hotspots = [
                { lat: 27.1865, lng: 56.2768, name: 'Ù…ÛŒØ¯Ø§Ù† Ø´Ù‡Ø¯Ø§', congestion: 85 },
                { lat: 27.1920, lng: 56.2650, name: 'Ø¨Ù„ÙˆØ§Ø± Ø§Ù…Ø§Ù…', congestion: 72 },
                { lat: 27.1750, lng: 56.2850, name: 'Ú†Ù‡Ø§Ø±Ø±Ø§Ù‡ Ø³Ø§Ø­Ù„', congestion: 68 }
            ];
            
            hotspots.forEach(hotspot => {
                L.circleMarker([hotspot.lat, hotspot.lng], {
                    radius: 20,
                    fillColor: '#FFCC00',
                    color: '#FF9900',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.7
                }).addTo(map).bindPopup(`
                    <b>${hotspot.name}</b><br>
                    ØªØ±Ø§Ú©Ù… ØªØ±Ø§ÙÛŒÚ©: ${hotspot.congestion}%<br>
                    <span style="color: ${hotspot.congestion > 80 ? 'red' : 'orange'}">
                        ${hotspot.congestion > 80 ? 'âš ï¸ Ù†Ø³Ø¨ØªØ§Ù‹ Ø³Ù†Ú¯ÛŒÙ†' : 'âš ï¸ Ø³Ù†Ú¯ÛŒÙ†'}
                    </span>
                `);
            });
            
            alert('Ù†Ù‚Ø§Ø· Ù¾Ø±ØªØ±Ø§ÙÛŒÚ© Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù†Ø¯');
        }
        
        // ØªØºÛŒÛŒØ± Ø§Ø³ØªØ§ÛŒÙ„ Ù†Ù‚Ø´Ù‡
        function changeMapStyle(style) {
            // Ø­Ø°Ù Ù„Ø§ÛŒÙ‡ ÙØ¹Ù„ÛŒ
            map.eachLayer(layer => {
                if (layer._url && layer._url.includes('tile')) {
                    map.removeLayer(layer);
                }
            });
            
            if (style === 'standard') {
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap',
                    maxZoom: 19,
                }).addTo(map);
            } else if (style === 'satellite') {
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Â© Esri',
                    maxZoom: 19,
                }).addTo(map);
            }
        }
        
        // ØµØ§Ø¯Ø± Ú©Ø±Ø¯Ù† Ù†Ù‚Ø´Ù‡
        function exportMap() {
            alert('Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù†ØµØ¨ html2canvas Ø¯Ø§Ø±Ø¯.\nØ¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‚Ø´Ù‡ Ø§Ø² Print Screen Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.');
        }
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ø¢Ù†Ù„Ø§ÛŒÙ†
        function updateOnlineCount(count) {
            document.getElementById('onlineCount').textContent = count;
        }
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 
                `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // Ù†ÙˆØ³Ø§Ø²ÛŒ Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù†
        function refreshDrivers() {
            loadDrivers();
            document.getElementById('backendStatus').innerHTML = 
                '<span class="pulse" style="color: #0044ff;">... Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</span>';
            setTimeout(() => {
                document.getElementById('backendStatus').innerHTML = 
                    '<span style="color: #00ff88;">âœ… Ù…ØªØµÙ„</span>';
            }, 2000);
        }
        
        // Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            locateMe();
            updateLastUpdate();
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† html2canvas Ø¨Ø±Ø§ÛŒ ØµØ§Ø¯Ø± Ú©Ø±Ø¯Ù† Ù†Ù‚Ø´Ù‡
            const script = document.createElement('script');
            script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
            document.head.appendChild(script);
        });
    </script>
</body>
</html>
